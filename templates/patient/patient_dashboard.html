{% extends 'patient/patientbase.html' %}
{% block content %}
{% load static %}
{% load math_filters %}

<style>
	.patient-dashboard {
		background: linear-gradient(135deg,#3498db 0%,#2980b9 100%);
		padding:30px 0;
		min-height:100vh;
		color:#fff;
	}
	.patient-dashboard::before{
		content:'';
		position:absolute;
		inset:0;
		background-image: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.03) 1px, transparent 1px),
						  radial-gradient(circle at 80% 80%, rgba(255,255,255,0.03) 1px, transparent 1px);
		background-size:50px 50px;
		z-index:0;
		animation:moveBackground 20s linear infinite;
	}
	@keyframes moveBackground{0%{background-position:0 0,25px 25px}100%{background-position:50px 50px,75px 75px}}
	.container{position:relative;z-index:1}
	.dashboard-header{text-align:center;margin-bottom:40px}
	.dashboard-title{font-size:2.6rem;font-weight:800;display:flex;align-items:center;justify-content:center;gap:12px}
	.dashboard-subtitle{font-size:1.05rem;opacity:.95}
	.welcome-section{background:rgba(255,255,255,0.95);color:#2c3e50;border-radius:20px;padding:36px;box-shadow:0 20px 60px rgba(0,0,0,0.12);border:1px solid rgba(255,255,255,0.3);margin-bottom:30px}
	.welcome-icon{font-size:3.8rem;color:#3498db;margin-bottom:16px}
	.stat-card{background:#fff;color:#2c3e50;border-radius:14px;padding:24px;text-align:center;box-shadow:0 12px 30px rgba(0,0,0,0.12);margin-bottom:18px}
	.stat-number{font-size:2.4rem;font-weight:700}
	.stat-label{text-transform:uppercase;font-weight:700;color:#566271}
	.quick-actions{background:#fff;border-radius:16px;padding:28px;box-shadow:0 12px 30px rgba(0,0,0,0.12);margin-top:20px}
	.action-btn{display:flex;align-items:center;gap:12px;justify-content:center;padding:16px;border-radius:12px;color:#fff;font-weight:700;text-decoration:none}
	.action-btn.request{background:linear-gradient(135deg,#e74c3c,#c0392b)}
	.action-btn.history{background:linear-gradient(135deg,#27ae60,#2ecc71)}
	.impact-section{background:linear-gradient(135deg,#2980b9,#1f78b6);color:#fff;padding:28px;border-radius:16px;margin-top:30px;box-shadow:0 12px 30px rgba(0,0,0,0.12)}
	@media(max-width:768px){ .dashboard-title{font-size:1.8rem} .welcome-section{padding:20px} .stat-number{font-size:1.8rem} }
</style>

<div class="patient-dashboard">
	<div class="container">
		<div class="dashboard-header">
			<h1 class="dashboard-title"><i class="fas fa-user-injured"></i> BloodBridge Patient Dashboard</h1>
			<p class="dashboard-subtitle">Manage your requests and track status</p>
		</div>

		{% if patient %}
			<div class="welcome-section">
				<div class="welcome-icon"><i class="fas fa-user-md"></i></div>
				<h2 style="margin-bottom:8px">{{ patient.get_name }}</h2>
				<p style="margin:0">Welcome! Use the actions below to request blood or view your request history.</p>
			</div>

			{% if messages %}
				{% for message in messages %}
					<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="border-radius:10px;">
						{{ message }}
						<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
					</div>
				{% endfor %}
			{% endif %}

			<div class="row">
				<div class="col-md-3">
					<div class="stat-card">
						<div class="stat-number">{{ total_requests }}</div>
						<div class="stat-label">Total Requests</div>
					</div>
				</div>
				<div class="col-md-3">
					<div class="stat-card">
						<div class="stat-number">{{ approved_requests }}</div>
						<div class="stat-label">Approved</div>
					</div>
				</div>
				<div class="col-md-3">
					<div class="stat-card">
						<div class="stat-number">{{ pending_requests }}</div>
						<div class="stat-label">Pending</div>
					</div>
				</div>
				<div class="col-md-3">
					<div class="stat-card">
						<div class="stat-number">{{ rejected_requests }}</div>
						<div class="stat-label">Rejected</div>
					</div>
				</div>
			</div>

			<div class="quick-actions">
				<h4 style="margin-bottom:18px"><i class="fas fa-bolt"></i> Quick Actions</h4>
				<div class="row">
					<div class="col-md-6 mb-3">
						<a href="{% url 'make-request' %}" class="action-btn request"><i class="fas fa-plus-circle"></i> Request Blood</a>
					</div>
					<div class="col-md-6 mb-3">
						<a href="{% url 'my-request' %}" class="action-btn history"><i class="fas fa-list-alt"></i> My Requests</a>
					</div>
					<div class="col-md-12 mb-1">
						<a href="{% url 'patient-nearby-donors' %}" class="action-btn history"><i class="fas fa-map-marked-alt"></i> Nearby Donor Map</a>
					</div>
				</div>
			</div>

			<div class="quick-actions" style="margin-top:20px;">
				<h4 style="margin-bottom:12px"><i class="fas fa-shield-alt"></i> Verification Badge</h4>
				{% if verification_badge %}
					<div style="background:#f8fafc;border-radius:12px;padding:14px;color:#1f2937;">
						<strong>{{ verification_badge.badge_name }}</strong> {% if verification_badge.is_verified %}✅{% else %}⏳{% endif %}
						<div style="margin-top:6px;color:#475569;">Trust score: {{ verification_badge.trust_score }}/100</div>
					</div>
				{% else %}
					<div style="color:#64748b;">No verification badge assigned yet.</div>
				{% endif %}
			</div>

			<div class="quick-actions" style="margin-top:20px;">
				<div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;">
					<h4 style="margin-bottom:0"><i class="fas fa-comment-dots"></i> Your Feedback</h4>
					<a href="{% url 'patient-feedback' %}" class="action-btn history" style="max-width:260px"><i class="fas fa-pen"></i> Write a Review</a>
				</div>

				{% if recent_feedbacks %}
					<div style="margin-top:14px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;">
						{% for fb in recent_feedbacks %}
							<div style="background:rgba(255,255,255,0.98);border:1px solid rgba(226,232,240,0.9);border-radius:16px;padding:14px;">
								<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;">
									<div style="font-weight:800;color:#0f172a;">{{ fb.feedback_for }} • {{ fb.created_at|date:"d M Y" }}</div>
									<div style="font-weight:900;color:#64748b;">
										{% star_range as stars %}
										<span style="color:#f1c40f;letter-spacing:1px;">{% for i in stars %}{% if fb.rating >= i %}★{% else %}☆{% endif %}{% endfor %}</span>
										{% if fb.admin_reaction %}<span style="margin-left:8px;">{{ fb.admin_reaction }}</span>{% endif %}
									</div>
								</div>
								<div style="margin-top:10px;color:#334155;white-space:pre-wrap;">{{ fb.message|truncatechars:220 }}</div>

								{% if fb.image1 or fb.image2 or fb.image3 %}
									<div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
										{% if fb.image1 %}<a href="{{ fb.image1.url }}" target="_blank"><img src="{{ fb.image1.url }}" alt="feedback image 1" style="width:96px;height:78px;border-radius:14px;object-fit:cover;border:1px solid rgba(226,232,240,0.9);"></a>{% endif %}
										{% if fb.image2 %}<a href="{{ fb.image2.url }}" target="_blank"><img src="{{ fb.image2.url }}" alt="feedback image 2" style="width:96px;height:78px;border-radius:14px;object-fit:cover;border:1px solid rgba(226,232,240,0.9);"></a>{% endif %}
										{% if fb.image3 %}<a href="{{ fb.image3.url }}" target="_blank"><img src="{{ fb.image3.url }}" alt="feedback image 3" style="width:96px;height:78px;border-radius:14px;object-fit:cover;border:1px solid rgba(226,232,240,0.9);"></a>{% endif %}
									</div>
								{% else %}
									<div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
										<img src="{% if fb.feedback_for == 'DONATION' %}{% static 'image/feedback_donation.svg' %}{% elif fb.feedback_for == 'REQUEST' %}{% static 'image/feedback_request.svg' %}{% else %}{% static 'image/feedback_general.svg' %}{% endif %}"
											 alt="feedback cover image"
											 style="width:96px;height:78px;border-radius:14px;object-fit:cover;border:1px solid rgba(226,232,240,0.9);">
									</div>
								{% endif %}

								{% if fb.admin_reply %}
									<div style="margin-top:12px;background:rgba(52,152,219,0.10);border:1px solid rgba(52,152,219,0.18);border-radius:14px;padding:10px 12px;">
										<div style="font-weight:900;color:#334155;">Admin Reply</div>
										<div style="margin-top:6px;color:#1f2937;white-space:pre-wrap;">{{ fb.admin_reply|truncatechars:220 }}</div>
									</div>
								{% endif %}
							</div>
						{% endfor %}
					</div>
				{% else %}
					<div style="margin-top:14px;color:#64748b;">No feedback submitted yet. Click “Write a Review” to share your experience.</div>
				{% endif %}
			</div>

			<div class="impact-section">
				<h5>Your Activity</h5>
				<p style="margin:0.5rem 0 0">Total units requested: <strong>{{ total_units_requested }} ml</strong> — Approved units: <strong>{{ total_approved_units }} ml</strong></p>
			</div>

		{% else %}
			<div class="stat-card" style="background:rgba(255,255,255,0.95);color:#c0392b;text-align:center">
				<i class="fas fa-exclamation-triangle" style="font-size:2rem"></i>
				<h4 style="margin-top:12px">Patient Profile Not Found</h4>
				<p>Please log in again or contact support.</p>
				<a href="{% url 'patientlogin' %}" class="btn btn-primary">Login</a>
			</div>
		{% endif %}
	</div>
</div>

<script>
	// Animate numbers (UI-only)
	(function(){
		document.querySelectorAll('.stat-number').forEach(function(el){
			const val = parseInt(el.textContent) || 0;
			let cur = 0;
			if(val>0){
				const step = Math.max(1, Math.floor(val/30));
				const t = setInterval(function(){
					cur += step;
					if(cur>=val){ el.textContent = val; clearInterval(t); } else el.textContent = cur;
				}, 25);
			}
		});
	})();
</script>

{% endblock content %}
